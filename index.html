<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JOUZA Audio Lab by Ondrex & some LLMs + Woschlej</title>
<style>
    :root { --primary: #00e5ff; --bg: #121212; --panel: #1e1e1e; --text: #e0e0e0; --danger: #ff5252; --warn: #ffd740; --success: #69f0ae; }
    body { font-family: 'Segoe UI', Roboto, monospace; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; height: 100vh; box-sizing: border-box; overflow: hidden; }

    /* LAYOUT */
    .container { display: grid; grid-template-columns: 3fr 1.2fr; gap: 20px; height: calc(100vh - 90px); }
    .main-panel { display: flex; flex-direction: column; gap: 15px; height: 100%; }
    .side-panel { display: flex; flex-direction: column; gap: 15px; height: 100%; }

    h1 { margin: 0; font-weight: 300; letter-spacing: 2px; color: var(--primary); text-transform: uppercase; font-size: 1.2rem; }
    
    /* DASHBOARD */
    .dashboard { background: #181818; border: 1px solid #333; border-radius: 6px; padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    
    /* VIZUALIZACE */
    .viz-container { position: relative; flex-grow: 0; height: 160px; background: #000; border: 1px solid #333; border-radius: 6px; overflow: hidden; }
    canvas { width: 100%; height: 100%; display: block; }
    .viz-select { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: var(--primary); border: 1px solid #444; font-size: 0.7em; cursor: pointer; }

    /* VU METERS */
    .vu-meter { display: flex; gap: 4px; height: 100%; align-items: flex-end; padding: 5px; background: #111; border-radius: 4px; border: 1px solid #333; }
    .vu-bar { width: 15px; background: #222; height: 100%; position: relative; border-radius: 2px; overflow: hidden; }
    .vu-level { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, #00e5ff 60%, #ffd740 80%, #ff5252 100%); transition: height 0.05s; }
    
    /* MAKRO OVLADAƒåE */
    .macro-box { display: flex; flex-direction: column; gap: 5px; }
    .macro-row { display: flex; align-items: center; gap: 10px; font-size: 0.8em; color: #888; }
    .macro-row input { flex-grow: 1; accent-color: var(--primary); }
    .macro-val { width: 30px; text-align: right; color: var(--primary); font-family: monospace; }

    /* EDITOR & KNIHOVNA */
    .editor-wrapper { flex-grow: 1; position: relative; border: 1px solid #333; border-radius: 6px; overflow: hidden; }
    textarea { width: 100%; height: 100%; background: #161616; color: #a9dc76; border: none; padding: 15px; font-family: 'Consolas', monospace; font-size: 13px; resize: none; outline: none; }
    
    /* NOV√Å KONZOLE - CSS */
    #consoleOutput { 
        background: #0a0a0a; 
        border: 1px solid #333; 
        border-radius: 6px; 
        padding: 8px; 
        font-family: 'Consolas', monospace; 
        font-size: 0.8em; 
        color: #888; 
        height: 80px; 
        overflow-y: auto; 
        white-space: pre-wrap;
    }
    .console-box.error { color: var(--danger); border-left: 3px solid var(--danger); }
    .console-box.success { color: var(--success); border-left: 3px solid var(--success); }

    .library-panel { background: var(--panel); border: 1px solid #333; border-radius: 6px; flex-grow: 1; overflow: hidden; display: flex; flex-direction: column; }
    .lib-list { overflow-y: auto; flex-grow: 1; }
    .lib-item { padding: 8px 12px; border-bottom: 1px solid #2a2a2a; cursor: pointer; font-size: 0.9em; display:flex; justify-content:space-between; }
    .lib-item:hover { background: #2a2a2a; border-left: 2px solid var(--primary); }
    .lib-item small { color: #666; }

    /* OSTATN√ç */
    .controls { background: var(--panel); padding: 10px; border-radius: 6px; display: flex; gap: 10px; align-items: center; border: 1px solid #333; }
    button { padding: 6px 14px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; background: #333; transition: 0.2s; font-size: 0.85em; }
    button:hover { background: #555; }
    .btn-play { background: #2e7d32; } .btn-stop { background: #c62828; } .btn-save { background: #1565c0; }
    input[type=text] { background: #111; border: 1px solid #444; color: white; padding: 6px; border-radius: 4px; flex-grow: 1; }
    select { background: #222; color: white; border: 1px solid #444; padding: 5px; }

    /* FOOTER & LOGIN */
    #app-footer { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: #000; border-top: 1px solid #222; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; filter: blur(10px); opacity: 0; pointer-events: none; transition: 0.5s; }
    body.logged-in #app-footer { filter: none; opacity: 1; pointer-events: all; }
    .footer-links a { color: #888; text-decoration: none; margin: 0 10px; font-size: 0.9em; }
    .footer-links a:hover { color: var(--primary); }
    
    #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0a0a0a; z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    body.logged-in #login-overlay { display: none; }

    #app-content { filter: blur(10px); opacity: 0; transition: 0.5s; }
    body.logged-in #app-content { filter: none; opacity: 1; }
</style>
</head>
<body>

    <div id="login-overlay">
        <h2 style="color:var(--primary); font-weight:300; letter-spacing:2px;">JOUZA AUDIO LAB <span style="font-size:0.5em; opacity:0.5">v2.1</span></h2>
        <input type="password" id="passwordInput" style="padding:10px; background:#222; border:1px solid #444; color:white; text-align:center; margin:15px 0;" placeholder="P≈ô√≠stupov√Ω kl√≠ƒç">
        <button onclick="cloudLogin()" style="background:var(--primary); color:black;">VSTOUPIT</button>
        <p id="login-error" style="color:var(--danger); font-size:0.8em; margin-top:10px; height:20px;"></p>
    </div>

    <div id="app-content" class="container">
        
        <div class="main-panel">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h1>Web Audio API Lab</h1>
                <div id="status" style="font-size:0.8em; color:#666; font-family:monospace;">READY</div>
            </div>

            <div class="dashboard">
                <div class="viz-container">
                    <select class="viz-select" id="vizType" onchange="vizMode=this.value">
                        <option value="wave">‚ö° Osciloskop</option>
                        <option value="bar">üìä Spektrum</option>
                    </select>
                    <canvas id="visualizer"></canvas>
                </div>

                <div style="display:flex; gap:10px;">
                    <div class="vu-meter">
                        <div class="vu-bar"><div id="vuL" class="vu-level" style="height:0%"></div></div>
                        <div class="vu-bar"><div id="vuR" class="vu-level" style="height:0%"></div></div>
                        <div style="writing-mode: vertical-rl; font-size: 0.7em; color:#555; text-align:center;">MASTER</div>
                    </div>

                    <div class="macro-box" style="flex-grow:1;">
                        <div style="font-size:0.7em; color:var(--primary); margin-bottom:5px;">üéõÔ∏è MAKRO PARAMETRY (Live)</div>
                        
                        <div class="macro-row">
                            <span>A</span>
                            <input type="range" id="macA" min="0" max="1000" value="50" oninput="updateMacros()">
                            <span id="valA" class="macro-val">50</span>
                        </div>
                        <div class="macro-row">
                            <span>B</span>
                            <input type="range" id="macB" min="0" max="100" value="50" oninput="updateMacros()">
                            <span id="valB" class="macro-val">0.5</span>
                        </div>
                        <div class="macro-row">
                            <span>C</span>
                            <input type="range" id="macC" min="0" max="1" step="0.01" value="0.5" oninput="updateMacros()">
                            <span id="valC" class="macro-val">0.5</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="editor-wrapper">
                <textarea id="editor" spellcheck="false" placeholder="// Zde pi≈°te sv≈Øj k√≥d... Pou≈æijte pA, pB, pC pro ovl√°d√°n√≠ makry!"></textarea>
            </div>

            <div id="consoleOutput">System Ready. Waiting for input...</div>

            <div class="controls">
                <button class="btn-play" onclick="playAudio()">‚ñ∂ RUN</button>
                <button class="btn-stop" onclick="stopAudio()">‚èπ STOP</button>
                <input type="range" id="masterVolume" min="0" max="1" step="0.01" value="0.5" style="width:100px;">
                <input type="text" id="fnName" placeholder="N√°zev experimentu...">
                <button class="btn-save" onclick="saveToSheets()">üíæ ULO≈ΩIT</button>
            </div>
        </div>

        <div class="side-panel">
            <div style="background:#222; padding:10px; border-radius:6px; border:1px solid #333;">
                <select id="presetSelect" onchange="loadPreset()" style="width:100%;">
                    <option value="" disabled selected>üìÇ Presety</option>
                    <option value="macro">üéõÔ∏è Test Maker</option>
                    <option value="zen">üßò Zen M√≠sa</option>
                    <option value="fire">üî• T≈ô√≠da Ohe≈à</option>
                </select>
            </div>
            
            <div class="library-panel">
                <div style="padding:10px; border-bottom:1px solid #333; font-size:0.8em; color:#888;">
                    CLOUD KNIHOVNA
                    <button onclick="loadFromSheets()" style="float:right; padding:2px 8px; font-size:0.9em;">‚Üª</button>
                </div>
                <div id="library" class="lib-list"></div>
            </div>
        </div>
    </div>

    <footer id="app-footer">
        <div class="footer-links">
            <a href="https://www.ember-pa.cz/" target="_blank">üî• Ember PA</a> | 
            <a href="https://open.spotify.com/user/ondrex?si=82674543a7874e3d" target="_blank">üéµ Spotify</a> | 
            <a href="https://ondrex-ember.github.io/doupe-2/" target="_blank">üëæ Doupƒõ 2</a> |
            <a href="https://ondrex-ember.github.io/tech-1000-piv/" target="_blank">üç∫</a>
        </div>
        <div style="color:#666; font-size:0.75em;">Vyv√≠jeno s <span style="color:#e91e63">‚ù§Ô∏è</span> v Nov√©m Boru by <strong>Ondrex</strong></div>
    </footer>

<script>
    // ==========================================
    // 1. KONFIGURACE A PROMƒöNN√â
    // ==========================================
    const SHEETS_URL = "https://script.google.com/macros/s/AKfycbwe8O3qqe-C0yLm08EDFZGqHkEIdswZ6DCAuTd4rSMM90P5bp1HZCGw4G9jg7gU0W2I/exec"; 
    
    let audioCtx, masterGain, analyser, animationId;
    let activeIntervals = [];
    let vizMode = 'wave';
    window.MACROS = { A: 50, B: 0.5, C: 0.5 };

    function updateMacros() {
        const a = parseFloat(document.getElementById('macA').value);
        const b = parseFloat(document.getElementById('macB').value) / 100;
        const c = parseFloat(document.getElementById('macC').value);
        
        document.getElementById('valA').innerText = a;
        document.getElementById('valB').innerText = b.toFixed(2);
        document.getElementById('valC').innerText = c.toFixed(2);
        
        window.MACROS = { A: a, B: b, C: c };
    }

    // ==========================================
    // 2. KONZOLE A DIAGNOSTIKA
    // ==========================================
    function logToConsole(msg, type = 'info') {
        const con = document.getElementById('consoleOutput');
        if (!con) { console.log("> " + msg); return; }
        
        const time = new Date().toLocaleTimeString();
        con.innerText = "[" + time + "] " + msg;
        con.className = 'console-box'; 
        if (type === 'error') con.classList.add('error');
        if (type === 'success') con.classList.add('success');
    }

    function checkBrackets(code) {
        const openCb = (code.match(/{/g) || []).length;
        const closeCb = (code.match(/}/g) || []).length;
        if (openCb !== closeCb) return "Nesed√≠ slo≈æen√© z√°vorky { }. Otev≈ôeno: " + openCb + ", Zav≈ôeno: " + closeCb;
        
        const openRb = (code.match(/\(/g) || []).length;
        const closeRb = (code.match(/\)/g) || []).length;
        if (openRb !== closeRb) return "Nesed√≠ kulat√© z√°vorky ( ). Otev≈ôeno: " + openRb + ", Zav≈ôeno: " + closeRb;
        
        return null;
    }

    // ==========================================
    // 3. AUDIO ENGINE
    // ==========================================
    function initAudio() {
        if (!audioCtx || audioCtx.state === 'closed') {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            masterGain = audioCtx.createGain();
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 2048;
            analyser.smoothingTimeConstant = 0.85;
            
            masterGain.connect(analyser);
            analyser.connect(audioCtx.destination);
            visualize();
        }
        
        const vol = document.getElementById('masterVolume').value;
        if(masterGain) masterGain.gain.value = vol;
    }

    function playAudio() {
        stopAudio();
        const code = document.getElementById('editor').value;

        const bracketError = checkBrackets(code);
        if (bracketError) { logToConsole("SYNTAX ERROR: " + bracketError, 'error'); return; }

        try { new Function('ctx', 'destination', 'window', code); } 
        catch (e) { logToConsole("SYNTAX ERROR: " + e.message, 'error'); return; }

        initAudio();
        if (audioCtx.state === 'suspended') audioCtx.resume();

        const userOut = audioCtx.createGain();
        userOut.connect(masterGain);

        try {
            const wrapper = `
                const audioContext = ctx; 
                const destination = userOut; 
                const getA = () => window.MACROS.A; 
                const getB = () => window.MACROS.B; 
                const getC = () => window.MACROS.C; 
                ${code}
            `;
            const run = new Function('ctx', 'userOut', 'window', wrapper);
            run(audioCtx, userOut, window);
            
            logToConsole("Kompilace √∫spƒõ≈°n√°. Audio bƒõ≈æ√≠.", "success");
            document.getElementById('status').innerText = "PLAYING";
        } catch (e) {
            logToConsole("RUNTIME ERROR: " + e.message, 'error');
            stopAudio();
        }
    }

    function stopAudio() {
        activeIntervals.forEach(clearInterval);
        activeIntervals = [];

        if (animationId) cancelAnimationFrame(animationId);

        if (audioCtx) {
            if(masterGain) masterGain.disconnect();
            audioCtx.close().then(() => { 
                audioCtx = null; 
                document.getElementById('status').innerText = "STOP"; 
            });
        }
        
        document.getElementById('vuL').style.height = '0%';
        document.getElementById('vuR').style.height = '0%';
        document.getElementById('status').innerText = "STOP"; 
    }

    // ==========================================
    // 4. VIZUALIZACE A CLOUD
    // ==========================================
    function visualize() {
        const canvas = document.getElementById('visualizer');
        if(!canvas) return;
        
        canvas.width = canvas.clientWidth;
        canvas.height = canvas.clientHeight;

        const ctx = canvas.getContext('2d');
        const bufferLen = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLen);
        const timeArray = new Uint8Array(bufferLen);

        function draw() {
            if (!audioCtx || audioCtx.state === 'closed') return;
            animationId = requestAnimationFrame(draw);
            
            analyser.getByteFrequencyData(dataArray);
            analyser.getByteTimeDomainData(timeArray);

            let sum = 0;
            for(let i=0; i<bufferLen; i++) {
                const x = (timeArray[i] - 128) / 128.0;
                sum += x * x;
            }
            const rms = Math.sqrt(sum / bufferLen);
            const vuHeight = Math.min(100, rms * 400);
            
            const vuL = document.getElementById('vuL');
            const vuR = document.getElementById('vuR');
            if(vuL) vuL.style.height = vuHeight + '%';
            if(vuR) vuR.style.height = vuHeight + '%';

            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (vizMode === 'bar') {
                const barWidth = (canvas.width / bufferLen) * 2.5;
                let x = 0;
                for (let i = 0; i < bufferLen; i++) {
                    const h = (dataArray[i] / 255) * canvas.height;
                    const r = h + (25 * (i/bufferLen));
                    ctx.fillStyle = "rgb(" + r + "," + (250 * (i/bufferLen)) + ",50)";
                    ctx.fillRect(x, canvas.height - h, barWidth, h);
                    x += barWidth + 1;
                }
            } else {
                ctx.lineWidth = 2; 
                ctx.strokeStyle = '#00e5ff'; 
                ctx.beginPath();
                const sliceWidth = canvas.width / bufferLen;
                let x = 0;
                for (let i = 0; i < bufferLen; i++) {
                    const v = timeArray[i] / 128.0;
                    const y = v * canvas.height / 2;
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                    x += sliceWidth;
                }
                ctx.lineTo(canvas.width, canvas.height / 2); 
                ctx.stroke();
            }
        }
        draw();
    }

    async function cloudLogin() {
        const input = document.getElementById('passwordInput').value;
        const err = document.getElementById('login-error');
        const btn = document.querySelector('#login-overlay button');
        
        if (!input) return;
        err.innerText = "Ovƒõ≈ôuji...";
        if (btn) btn.disabled = true;

        try {
            const res = await fetch(SHEETS_URL, {
                method: 'POST', 
                mode: 'cors', 
                redirect: 'follow',
                body: JSON.stringify({ action: "login", password: input }),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            });
            const data = await res.json();

            if (data.status === 'success') {
                logToConsole("P≈ôihl√°≈°en√≠ √∫spƒõ≈°n√©", "success");
                document.body.classList.add('logged-in');
                sessionStorage.setItem('cloudAuth', 'true');
                loadFromSheets();
            } else {
                err.innerText = data.message || "Nespr√°vn√© heslo.";
                err.style.color = "var(--danger)";
                if (btn) btn.disabled = false;
            }
        } catch (e) {
            console.error(e);
            err.innerText = "Chyba komunikace. Zkontrolujte log.";
            if (btn) btn.disabled = false;
        }
    }

    async function saveToSheets() {
        const code = document.getElementById('editor').value;
        const name = document.getElementById('fnName').value || "Bez n√°zvu";
        logToConsole("Ukl√°d√°m do cloudu...", "info");
        try {
            await fetch(SHEETS_URL, { method: 'POST', body: JSON.stringify({ action: "save", name, code }) });
            logToConsole("Ulo≈æeno!", "success");
        } catch(e) { logToConsole("Chyba ukl√°d√°n√≠", "error"); }
    }

    async function loadFromSheets() {
        const lib = document.getElementById('library');
        lib.innerHTML = "Naƒç√≠t√°m...";
        try {
            const res = await fetch(SHEETS_URL);
            const data = await res.json();
            lib.innerHTML = "";
            data.reverse().forEach(item => {
                const el = document.createElement('div'); 
                el.className = 'lib-item';
                el.innerHTML = "<strong>" + item.name + "</strong>";
                el.onclick = () => { 
                    document.getElementById('editor').value = item.code; 
                    document.getElementById('fnName').value = item.name; 
                };
                lib.appendChild(el);
            });
        } catch(e) { lib.innerHTML = "Chyba naƒç√≠t√°n√≠"; }
    }

    if (sessionStorage.getItem('cloudAuth') === 'true') document.body.classList.add('logged-in');

    const originalSetInterval = window.setInterval;
    window.setInterval = function(func, delay) {
        const id = originalSetInterval(func, delay);
        activeIntervals.push(id);
        return id;
    };

    const PRESETS = {
        macro: `// --- MAKRO TEST ---
const osc = ctx.createOscillator();
const gain = ctx.createGain();
osc.type = 'sawtooth';
osc.connect(gain); gain.connect(destination);
osc.start();

setInterval(() => {
  osc.frequency.setTargetAtTime(getA(), ctx.currentTime, 0.05);
  gain.gain.setTargetAtTime(getB(), ctx.currentTime, 0.05);
}, 50);`,

        zen: `// --- ZEN MISA ---
const freq = 200 + getA(); 
const t = ctx.currentTime;

const addLayer = (f, gain, decay, detune = 0) => {
    const osc = ctx.createOscillator();
    const g = ctx.createGain();
    
    osc.frequency.value = f + detune;
    osc.type = 'sine';

    g.gain.setValueAtTime(0, t);
    g.gain.linearRampToValueAtTime(gain, t + 0.05);
    g.gain.exponentialRampToValueAtTime(0.00001, t + decay);

    osc.connect(g);
    g.connect(destination);
    
    osc.start(t);
    osc.stop(t + decay);
};

addLayer(freq, 0.2, 5);
addLayer(freq * 2, 0.1, 4);
addLayer(freq * 3.01, 0.05, 3);
addLayer(freq * 4.45, 0.03, 2);
addLayer(freq * 0.5, 0.15, 6, Math.sin(t)*2);
addLayer(freq * 0.502, 0.15, 6);`,

        fire: `// --- T≈ò√çDA OHE≈á ---
// (Pro vlo≈æen√≠ k√≥du pou≈æijte t≈ô√≠du z minul√© konverzace)`
    };

    function loadPreset() {
        const val = document.getElementById('presetSelect').value;
        if (PRESETS[val]) document.getElementById('editor').value = PRESETS[val];
    }
</script>

</body>
</html>
