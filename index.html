<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JOUZA AUDIO LAB v5.7 (Pulse Fix)</title>
<style>
    :root { 
        --primary: #00e5ff; 
        --bg: #0f0f0f; 
        --panel: #1a1a1a; 
        --text: #e0e0e0; 
        --danger: #ff4081; 
        --warn: #ffd740; 
        --success: #00e676; 
        --code-bg: #141414;
        --border: #333;
    }
    
    * { box-sizing: border-box; }
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: #0f0f0f; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 5px; }

    body { 
        font-family: 'Segoe UI', Roboto, sans-serif; 
        background-color: var(--bg); color: var(--text); 
        margin: 0; padding: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column;
    }

    #app-content {
        display: grid;
        grid-template-columns: 3fr 1.2fr;
        grid-template-rows: auto 1fr auto; 
        gap: 15px; padding: 15px; height: 100%; width: 100%;
        opacity: 0; filter: blur(10px); transition: opacity 0.5s, filter 0.5s;
    }
    body.logged-in #app-content { opacity: 1; filter: none; }

    /* HEADER FIX */
    header { grid-column: 1 / -1; display: flex; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 5px; gap: 15px; overflow: hidden; }
    h1 { margin: 0; font-weight: 200; letter-spacing: 3px; color: var(--primary); text-transform: uppercase; font-size: 1.2rem; width: 200px; flex-shrink: 0; white-space: nowrap; }
    h1 span { font-weight: 700; color: #fff; }

    /* BIO MONITOR FIX */
    .bio-monitor { display: flex; align-items: center; gap: 10px; flex-grow: 1; min-width: 0; /* D≈Øle≈æit√© pro flexbox */ }
    
    #bp-canvas { 
        flex-grow: 1; 
        height: 35px; 
        border-radius: 4px; 
        background: rgba(0,0,0,0.4); 
        border: 1px solid #222; 
        min-width: 0; /* Zabr√°n√≠ roztahov√°n√≠ */
    }
    
    #status { 
        font-size: 0.7em; color: #666; font-family: monospace; font-weight: bold;
        border: 1px solid #333; padding: 4px 10px; border-radius: 4px; 
        flex-shrink: 0; transition: 0.3s; text-transform: uppercase; white-space: nowrap;
    }

    .main-area { display: flex; flex-direction: column; gap: 10px; height: 100%; overflow: hidden; }

    .dashboard { 
        display: grid; grid-template-columns: 1.5fr 1fr; gap: 10px; 
        background: var(--panel); padding: 10px; border-radius: 6px; border: 1px solid var(--border); flex-shrink: 0; 
    }

    .viz-wrapper { position: relative; height: 180px; background: #000; border-radius: 4px; border: 1px solid var(--border); overflow: hidden; }
    canvas#visualizer { width: 100%; height: 100%; display: block; }
    .viz-select { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.8); color: var(--primary); border: 1px solid #444; font-size: 0.7em; cursor: pointer; padding: 2px; z-index: 10; }

    .controls-grid { display: flex; gap: 10px; }
    .vu-section { display: flex; gap: 3px; height: 100%; padding: 5px; background: #0a0a0a; border: 1px solid var(--border); border-radius: 4px; }
    .vu-bar { width: 12px; background: #222; height: 100%; position: relative; border-radius: 2px; overflow: hidden; }
    .vu-level { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, var(--primary) 60%, var(--warn) 80%, var(--danger) 100%); transition: height 0.08s ease-out; }

    .macro-section { flex-grow: 1; display: flex; flex-direction: column; justify-content: space-around; padding: 0 5px; }
    .macro-row { display: flex; align-items: center; gap: 10px; font-size: 0.75em; color: #888; }
    .macro-row label { width: 10px; font-weight: bold; color: var(--primary); }
    .macro-row input { flex-grow: 1; accent-color: var(--primary); cursor: pointer; height: 4px; }
    .macro-val { width: 35px; text-align: right; font-family: monospace; color: #fff; }

    .editor-container { 
        flex-grow: 1; display: flex; flex-direction: column; border: 1px solid var(--border); border-radius: 6px; background: var(--code-bg); overflow: hidden; position: relative;
    }
    .editor-header {
        background: #1f1f1f; padding: 5px 10px; font-size: 0.75em; color: #666; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between;
    }
    textarea#editor { 
        flex-grow: 1; width: 100%; background: transparent; color: #d4d4d4; border: none; padding: 15px; font-family: 'Fira Code', monospace; font-size: 14px; line-height: 1.5; resize: none; outline: none; white-space: pre;
    }

    #consoleOutput { 
        height: 100px; background: #080808; border: 1px solid var(--border); border-radius: 6px; padding: 8px; font-family: monospace; font-size: 0.8em; color: #aaa; overflow-y: auto; display: flex; flex-direction: column; gap: 2px;
    }
    .log-line { display: flex; gap: 10px; border-bottom: 1px solid #111; padding: 2px 0; }
    .log-sys { color: var(--primary); font-style: italic; }

    .controls { display: flex; gap: 10px; padding: 10px 0; align-items: center; }
    button { padding: 8px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; background: #333; font-size: 0.85em; text-transform: uppercase; transition: 0.2s; }
    button:hover { filter: brightness(1.2); }
    .btn-play { background: #2e7d32; } 
    .btn-stop { background: #c62828; } 
    .btn-save { background: #1565c0; margin-left: auto; }
    input[type=range].master-vol { width: 100px; }
    input[type=text] { background: #111; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; width: 220px; }

    .side-panel { display: flex; flex-direction: column; gap: 15px; height: 100%; overflow: hidden; }
    .panel-box { background: var(--panel); border: 1px solid var(--border); border-radius: 6px; display: flex; flex-direction: column; overflow: hidden; }
    .panel-header { padding: 10px; background: #222; border-bottom: 1px solid var(--border); font-size: 0.8em; font-weight: bold; color: #888; display: flex; justify-content: space-between; align-items: center; }
    select { width: 100%; padding: 10px; background: #111; color: #fff; border: none; }
    .lib-list { overflow-y: auto; flex-grow: 1; padding: 5px; }
    .lib-item { padding: 8px 10px; border-bottom: 1px solid #2a2a2a; cursor: pointer; font-size: 0.85em; border-radius: 4px; }
    .lib-item:hover { background: #2a2a2a; color: var(--primary); }

    #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #050505; z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    body.logged-in #login-overlay { display: none; }
    #login-overlay input { text-align: center; font-size: 1.2rem; width: 300px; padding: 15px; margin-bottom: 20px; border: 1px solid #333; background: #111; color: white; }
    #login-overlay button { font-size: 1rem; padding: 10px 40px; background: var(--primary); color: #000; }

    footer { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border); padding-top: 10px; font-size: 0.75em; color: #555; }
    .footer-links a { color: #777; text-decoration: none; margin-right: 15px; }
</style>
</head>
<body>

    <div id="login-overlay">
        <h2 style="color:var(--primary); font-weight:300; letter-spacing:4px; margin-bottom:30px;">JOUZA AUDIO LAB <span style="font-size:0.5em; opacity:0.5">v5.7</span></h2>
        <input type="password" id="passwordInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <button id="loginBtn" onclick="cloudLogin()">VSTOUPIT</button>
        <p id="login-error" style="color:var(--danger); height:20px; margin-top:15px;"></p>
    </div>

    <div id="app-content">
        
        <header>
            <h1>JOUZA <span>AUDIO LAB</span></h1>
            <div class="bio-monitor">
                <canvas id="bp-canvas" title="Arteri√°ln√≠ tlakov√° k≈ôivka"></canvas>
                <div id="status">SYSTEM READY</div>
            </div>
        </header>

        <div class="main-area">
            
            <div class="dashboard">
                <div class="viz-wrapper">
                    <select class="viz-select" id="vizType" onchange="vizMode=this.value">
                        <option value="wave">‚ö° Osciloskop</option>
                        <option value="bar">üìä Spektrum</option>
                        <option value="radial">üåÄ Radi√°ln√≠ Basy</option>
                    </select>
                    <canvas id="visualizer"></canvas>
                </div>

                <div class="controls-grid">
                    <div class="vu-section">
                        <div class="vu-bar"><div id="vuL" class="vu-level" style="height:0%"></div></div>
                        <div class="vu-bar"><div id="vuR" class="vu-level" style="height:0%"></div></div>
                    </div>
                    
                    <div class="macro-section">
                        <div class="macro-row"><label>A</label><input type="range" id="macA" min="0" max="1000" value="50" oninput="updateMacros()"><span id="valA" class="macro-val">50</span></div>
                        <div class="macro-row"><label>B</label><input type="range" id="macB" min="0" max="100" value="50" oninput="updateMacros()"><span id="valB" class="macro-val">0.5</span></div>
                        <div class="macro-row"><label>C</label><input type="range" id="macC" min="0" max="1" step="0.01" value="0.5" oninput="updateMacros()"><span id="valC" class="macro-val">0.5</span></div>
                    </div>
                </div>
            </div>

            <div class="editor-container">
                <div class="editor-header"><span>JAVASCRIPT EDITOR</span><span>Use: ctx, destination, getA(), getB(), getC()</span></div>
                <textarea id="editor" spellcheck="false" placeholder="// Napi≈° k√≥d a stiskni RUN..."></textarea>
            </div>

            <div id="consoleOutput">
                <div class="log-line"><span class="log-sys">Jouza Lab v5.7 Pulse Fix Applied.</span></div>
            </div>

            <div class="controls">
                <button class="btn-play" onclick="playAudio()">‚ñ∂ RUN CODE</button>
                <button class="btn-stop" onclick="stopAudio()">‚èπ KILL ALL</button>
                <div style="width: 1px; height: 30px; background: #333; margin: 0 10px;"></div>
                <span style="font-size:0.8em; color:#666;">MASTER:</span>
                <input type="range" id="masterVolume" class="master-vol" min="0" max="1" step="0.01" value="0.5" oninput="setGlobalVolume(this.value)">
                <input type="text" id="fnName" placeholder="N√°zev experimentu...">
                <button class="btn-save" onclick="saveToSheets()">üíæ ULO≈ΩIT</button>
            </div>
        </div>

        <div class="side-panel">
            <div class="panel-box" style="flex-shrink: 0;">
                <div class="panel-header">PRESETY</div>
                <select id="presetSelect" onchange="loadPreset()" size="8" style="height: 160px;">
                    <option value="macro">üéõÔ∏è Test Maker (Osc)</option>
                    <option value="zen">üßò Zen M√≠sa (Ambient)</option>
                    <option value="fire">üî• Class Ohe≈à (AudioSystem)</option>
                    <option value="acid">üß¨ ACID Tekno (303)</option>
                    <option value="nomad">‚õ∫ NOMAD Drone</option>
                    <option value="psy">üëΩ PSY FM Squelch</option>
                    <option value="unstoppable">‚ò†Ô∏è UNSTOPPABLE FIRE</option>
                </select>
            </div>
            <div class="panel-box" style="flex-grow: 1;">
                <div class="panel-header">CLOUD KNIHOVNA <span onclick="loadFromSheets()" style="cursor:pointer; color:var(--primary)">‚Üª</span></div>
                <div id="library" class="lib-list"></div>
            </div>
        </div>

        <footer>
            <div class="footer-links">
                <a href="https://www.ember-pa.cz/" target="_blank">üî• Ember PA</a> | <a href="https://open.spotify.com/user/ondrex?si=bac785a31b564159" target="_blank">üéµ Spotify</a> | <a href="https://ondrex-ember.github.io/doupe-2/" target="_blank">üëæ Doupƒõ 2</a> | <a href="https://ondrex-ember.github.io/tech-1000-piv/" target="_blank">üç∫</a>
            </div>
            <div>Vyv√≠jeno s <span style="color:#e91e63">‚ù§Ô∏è</span> v Nov√©m Boru. <strong>By Ondrex</strong> & <strong>Claude</strong> (feat. <strong>Woschlina</strong>)</div>
        </footer>
    </div>

<script>
    // ==========================================
    // 0. DEEP CLEAN & TRACKING
    // ==========================================
    const _trackedContexts = [], _trackedTimeouts = [], _trackedIntervals = [];
    let bpData = []; 

    const OriginalAudioContext = window.AudioContext || window.webkitAudioContext;
    window.AudioContext = window.webkitAudioContext = function(...args) {
        const ctx = new OriginalAudioContext(...args);
        _trackedContexts.push(ctx);
        const hijackGain = ctx.createGain();
        hijackGain.gain.value = document.getElementById('masterVolume').value;
        hijackGain.connect(ctx.destination);
        ctx._hijackGain = hijackGain;
        try { Object.defineProperty(ctx, 'destination', { get: function() { return hijackGain; } }); } catch(e) {}
        return ctx;
    };

    function setGlobalVolume(val) {
        if(masterGain) masterGain.gain.value = val;
        _trackedContexts.forEach(ctx => { if(ctx._hijackGain) ctx._hijackGain.gain.value = val; });
    }

    const SHEETS_URL = "https://script.google.com/macros/s/AKfycbwe8O3qqe-C0yLm08EDFZGqHkEIdswZ6DCAuTd4rSMM90P5bp1HZCGw4G9jg7gU0W2I/exec"; 
    let audioCtx, masterGain, analyser, animationId, bpAnimationId;
    let vizMode = 'wave';
    window.MACROS = { A: 50, B: 0.5, C: 0.5 };

    function updateMacros() {
        window.MACROS.A = parseFloat(document.getElementById('macA').value);
        window.MACROS.B = parseFloat(document.getElementById('macB').value) / 100;
        window.MACROS.C = parseFloat(document.getElementById('macC').value);
        document.getElementById('valA').innerText = window.MACROS.A;
        document.getElementById('valB').innerText = window.MACROS.B.toFixed(2);
        document.getElementById('valC').innerText = window.MACROS.C.toFixed(2);
    }

    function logToConsole(msg, type = 'info') {
        const con = document.getElementById('consoleOutput');
        const line = document.createElement('div');
        line.className = 'log-line';
        line.innerHTML = `<span class="log-sys">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
        con.appendChild(line);
        con.scrollTop = con.scrollHeight;
    }

    function initAudio() {
        if (!audioCtx || audioCtx.state === 'closed') {
            audioCtx = new OriginalAudioContext();
            masterGain = audioCtx.createGain();
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 1024;
            masterGain.connect(analyser);
            analyser.connect(audioCtx.destination);
            visualize();
            drawBioMonitor();
        }
        masterGain.gain.value = document.getElementById('masterVolume').value;
    }

    function playAudio() {
        stopAudio(); initAudio();
        const code = document.getElementById('editor').value;
        const userOut = audioCtx.createGain(); userOut.connect(masterGain);
        try {
            const wrapper = `const destination = userOut; const getA = () => window.MACROS.A; const getB = () => window.MACROS.B; const getC = () => window.MACROS.C; ${code}`;
            new Function('ctx', 'userOut', 'window', wrapper)(audioCtx, userOut, window);
            
            const st = document.getElementById('status');
            st.innerText = "RUNNING";
            st.style.color = "#00e676";
            st.style.borderColor = "#00e676";
            st.style.boxShadow = "0 0 10px rgba(0,230,118,0.3)";
            
            document.getElementById('fnName').value = `${new Date().getHours()}${new Date().getMinutes()}-${document.getElementById('presetSelect').value || 'exp'}`;
        } catch (e) { logToConsole(e.message); stopAudio(); }
    }

    function stopAudio() {
        _trackedIntervals.forEach(clearInterval); _trackedTimeouts.forEach(clearTimeout);
        _trackedContexts.forEach(ctx => { if (ctx.state !== 'closed') ctx.close(); });
        if (animationId) cancelAnimationFrame(animationId);
        if (audioCtx) audioCtx.close().then(() => { audioCtx = null; });
        
        const st = document.getElementById('status');
        st.innerText = "STOPPED";
        st.style.color = "#666";
        st.style.borderColor = "#333";
        st.style.boxShadow = "none";
    }

    function visualize() {
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        const bufferLen = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLen);
        const timeArray = new Uint8Array(bufferLen);

        function draw() {
            if (!audioCtx) return;
            animationId = requestAnimationFrame(draw);
            canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight;
            analyser.getByteFrequencyData(dataArray);
            analyser.getByteTimeDomainData(timeArray);

            let bass = 0; for(let i=0; i<10; i++) bass += dataArray[i]; bass /= 10;
            let rms = 0; for(let i=0; i<bufferLen; i++) { let x=(timeArray[i]-128)/128; rms+=x*x; }
            rms = Math.sqrt(rms/bufferLen);
            document.getElementById('vuL').style.height = document.getElementById('vuR').style.height = Math.min(100, rms*400) + '%';

            ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width, canvas.height);

            if (vizMode === 'radial') {
                const centerX = canvas.width / 2, centerY = canvas.height / 2;
                const baseRadius = 40 + (bass / 4);
                ctx.shadowBlur = bass / 5; ctx.shadowColor = '#00e5ff';
                for (let i = 0; i < bufferLen; i += 2) {
                    const angle = (i / bufferLen) * Math.PI * 2;
                    const h = (dataArray[i] / 255) * 60;
                    const x1 = centerX + Math.cos(angle) * baseRadius;
                    const y1 = centerY + Math.sin(angle) * baseRadius;
                    const x2 = centerX + Math.cos(angle) * (baseRadius + h);
                    const y2 = centerY + Math.sin(angle) * (baseRadius + h);
                    ctx.strokeStyle = `rgb(${dataArray[i]}, 100, 255)`;
                    ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
                }
            } else if (vizMode === 'bar') {
                let bw = (canvas.width / bufferLen) * 2.5, x = 0;
                for(let i=0; i<bufferLen; i++) {
                    let h = (dataArray[i]/255) * canvas.height;
                    ctx.fillStyle = `rgb(${h+50}, 50, ${255-h})`;
                    ctx.fillRect(x, canvas.height-h, bw, h); x += bw + 1;
                }
            } else {
                ctx.lineWidth = 2; ctx.strokeStyle = '#00e5ff'; ctx.beginPath();
                let sw = canvas.width / bufferLen, x = 0;
                for(let i=0; i<bufferLen; i++) {
                    let v = timeArray[i]/128.0, y = v * canvas.height/2;
                    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); x += sw;
                }
                ctx.stroke();
            }
        }
        draw();
    }

    // --- FIX: DRAW BIO MONITOR (Oddƒõlen√© resize) ---
    function drawBioMonitor() {
        const canvas = document.getElementById('bp-canvas');
        const ctx = canvas.getContext('2d');
        
        // Nastav√≠me velikost hned na zaƒç√°tku
        function resizeCanvas() {
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
            bpData = []; // Reset dat, aby se k≈ôivka nenat√°hla
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function animate() {
            bpAnimationId = requestAnimationFrame(animate);
            // ZDE BYL PROBL√âM: canvas.width = canvas.clientWidth; (Odstranƒõno)
            
            if (!audioCtx) { 
                ctx.clearRect(0,0,canvas.width, canvas.height);
                ctx.strokeStyle = '#333'; ctx.beginPath(); ctx.moveTo(0,canvas.height/2); ctx.lineTo(canvas.width,canvas.height/2); ctx.stroke(); 
                return; 
            }
            
            let rms = parseFloat(document.getElementById('vuL').style.height) || 0;
            let targetY = (canvas.height/2) - (Math.sin(Date.now()*0.01) * (rms*0.2));
            if(Math.sin(Date.now()*0.01) > 0.8) targetY -= 5;
            
            bpData.push(targetY); 
            if (bpData.length > canvas.width) bpData.shift();
            
            ctx.clearRect(0,0,canvas.width, canvas.height);
            ctx.strokeStyle = '#00e676'; ctx.lineWidth = 1.5; ctx.beginPath();
            for(let i=0; i<bpData.length; i++) { if(i===0) ctx.moveTo(i, bpData[i]); else ctx.lineTo(i, bpData[i]); }
            ctx.stroke();
        }
        animate();
    }

    async function cloudLogin() {
        const input = document.getElementById('passwordInput').value;
        const err = document.getElementById('login-error');
        if (!input) return; err.innerText = "Ovƒõ≈ôuji...";
        try {
            const res = await fetch(SHEETS_URL, { method: 'POST', body: JSON.stringify({ action: "login", password: input }) });
            const data = await res.json();
            if (data.status === 'success') { document.body.classList.add('logged-in'); loadFromSheets(); }
            else { err.innerText = "Nespr√°vn√© heslo."; }
        } catch (e) { err.innerText = "Chyba p≈ôipojen√≠."; }
    }

    async function saveToSheets() {
        const code = document.getElementById('editor').value, name = document.getElementById('fnName').value;
        await fetch(SHEETS_URL, { method: 'POST', body: JSON.stringify({ action: "save", name, code }) });
        logToConsole("Ulo≈æeno do cloudu.");
    }

    async function loadFromSheets() {
        const res = await fetch(SHEETS_URL); const data = await res.json();
        const lib = document.getElementById('library'); lib.innerHTML = "";
        data.reverse().forEach(item => {
            let el = document.createElement('div'); el.className = 'lib-item'; el.innerHTML = `<strong>${item.name}</strong>`;
            el.onclick = () => { document.getElementById('editor').value = item.code; document.getElementById('fnName').value = item.name; };
            lib.appendChild(el);
        });
    }

    const PRESETS = {
        macro: `// --- MAKRO TEST ---
const osc = ctx.createOscillator();
const gain = ctx.createGain();
osc.type = 'sawtooth';
osc.connect(gain); gain.connect(destination);
osc.start();

setInterval(() => {
  // A = Frekvence, B = Hlasitost
  osc.frequency.setTargetAtTime(getA(), ctx.currentTime, 0.05);
  gain.gain.setTargetAtTime(getB(), ctx.currentTime, 0.05);
}, 50);`,

        zen: `// --- ZEN MISA ---
const freq = 200 + getA(); 
const t = ctx.currentTime;
const addLayer = (f, gain, decay, detune = 0) => {
    const osc = ctx.createOscillator();
    const g = ctx.createGain();
    osc.frequency.value = f + detune;
    osc.type = 'sine';
    g.gain.setValueAtTime(0, t);
    g.gain.linearRampToValueAtTime(gain, t + 0.05);
    g.gain.exponentialRampToValueAtTime(0.00001, t + decay);
    osc.connect(g);
    g.connect(destination);
    osc.start(t);
    osc.stop(t + decay);
};
addLayer(freq, 0.2, 5); addLayer(freq * 2, 0.1, 4); addLayer(freq * 3.01, 0.05, 3);
addLayer(freq * 4.45, 0.03, 2); addLayer(freq * 0.5, 0.15, 6, Math.sin(t)*2);`,

        fire: `// --- T≈ò√çDA OHE≈á (Restored) ---
class AudioSystem {
    constructor() {
        this.audioContext = ctx; 
        this.masterGain = this.audioContext.createGain();
        this.masterGain.connect(destination);
        this.isPlaying = false;
        this.rumbleSrc = null;
    }
    start() {
        if(this.isPlaying) return;
        this.isPlaying = true;
        this.startRumble();
        this.updateLoop = setInterval(() => {
            const volume = getA() / 1000; 
            this.masterGain.gain.setTargetAtTime(volume, this.audioContext.currentTime, 0.1);
        }, 50);
    }
    startRumble() {
        const buf = this.audioContext.createBuffer(1, 44100, 44100);
        const data = buf.getChannelData(0);
        for(let i=0; i<44100; i++) data[i] = Math.random() * 2 - 1;
        const src = this.audioContext.createBufferSource();
        src.buffer = buf; src.loop = true;
        src.connect(this.masterGain); src.start();
        this.rumbleSrc = src;
    }
}
new AudioSystem().start();`,

        acid: `// --- ACID 303 ---
const osc = ctx.createOscillator(); const filter = ctx.createBiquadFilter();
const g = ctx.createGain(); osc.type = 'sawtooth';
filter.type = 'lowpass'; filter.Q.value = 20;
osc.connect(filter); filter.connect(g); g.connect(destination);
osc.start();
setInterval(() => {
  osc.frequency.setTargetAtTime(50 + (getB()*2), ctx.currentTime, 0.1);
  filter.frequency.setTargetAtTime(200 + getA(), ctx.currentTime, 0.1);
}, 50);`,

        nomad: `// --- NOMAD DRONE ---
for(let i=0; i<6; i++) {
  const o = ctx.createOscillator(); const g = ctx.createGain();
  o.type = 'sine'; o.frequency.value = 40 + (i*20); g.gain.value = 0.1;
  o.connect(g); g.connect(destination); o.start();
  setInterval(() => { o.frequency.setTargetAtTime(40+(i*20)+getA(), ctx.currentTime, 1); }, 1000);
}`,

        psy: `// --- PSY FM SQUELCH ---
const o = ctx.createOscillator(); const mod = ctx.createOscillator();
const mg = ctx.createGain(); mod.frequency.value = 10; mg.gain.value = getA();
mod.connect(o.frequency); o.connect(destination); o.start(); mod.start();`,

        unstoppable: `// --- ‚ò†Ô∏è UNSTOPPABLE FIRE (Original Sidechain) ---
(function() {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const startFire = () => {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const duration = 60; const now = audioCtx.currentTime;
        const noiseBuffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 5, audioCtx.sampleRate);
        const nd = noiseBuffer.getChannelData(0);
        for (let i = 0; i < nd.length; i++) nd[i] = Math.random() * 2 - 1;
        function makeDistortionCurve(amount) {
            const k = amount, n_samples = 44100, curve = new Float32Array(n_samples), deg = Math.PI / 180;
            for (let i = 0; i < n_samples; ++i) {
                const x = i * 2 / n_samples - 1; curve[i] = (3 + k) * x * 20 * deg / (Math.PI + k * Math.abs(x));
            } return curve;
        }
        const roar = audioCtx.createBufferSource(); roar.buffer = noiseBuffer; roar.loop = true;
        const roarF = audioCtx.createBiquadFilter(); roarF.type = 'lowpass'; roarF.frequency.value = 100;
        const distortion = audioCtx.createWaveShaper(); distortion.curve = makeDistortionCurve(15);
        const sidechainGain = audioCtx.createGain(); sidechainGain.gain.value = 1.0; 
        const roarG = audioCtx.createGain(); roarG.gain.value = 0.15;
        roar.connect(roarF); roarF.connect(distortion); distortion.connect(sidechainGain); sidechainGain.connect(roarG);
        roarG.connect(audioCtx.destination); roar.start(now);
        function applySidechain(reduction, attack, release) {
            const t = audioCtx.currentTime;
            sidechainGain.gain.cancelScheduledValues(t); sidechainGain.gain.setValueAtTime(sidechainGain.gain.value, t);
            sidechainGain.gain.linearRampToValueAtTime(1.0 - reduction, t + attack);
            sidechainGain.gain.exponentialRampToValueAtTime(1.0, t + attack + release);
        }
        function triggerLoudSnap() {
            if (audioCtx.currentTime > now + duration) return;
            applySidechain(0.5, 0.005, 0.4);
            const s = audioCtx.createBufferSource(); s.buffer = noiseBuffer;
            const f = audioCtx.createBiquadFilter(); f.type = 'bandpass'; f.frequency.value = 350;
            const g = audioCtx.createGain(); g.gain.setValueAtTime(0, audioCtx.currentTime);
            g.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 0.002);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
            s.connect(f); f.connect(g); g.connect(audioCtx.destination); s.start();
            setTimeout(triggerLoudSnap, 2000 + Math.random() * 2000);
        }
        triggerLoudSnap(); window.removeEventListener('click', startFire);
    };
    window.addEventListener('click', startFire);
})();`
    };

    function loadPreset() {
        const val = document.getElementById('presetSelect').value;
        if (PRESETS[val]) { document.getElementById('editor').value = PRESETS[val]; }
    }
</script>
</body>
</html>
